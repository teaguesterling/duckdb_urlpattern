# name: test/sql/urlpattern.test
# description: test urlpattern extension
# group: [sql]

# Require statement will ensure this test is run with this extension loaded
require urlpattern

#------------------------------------------------------------------------------
# urlpattern_test - Basic pattern matching
#------------------------------------------------------------------------------

# Wildcard match
query I
SELECT urlpattern_test('https://example.com/*', 'https://example.com/test');
----
true

# Exact non-match
query I
SELECT urlpattern_test('https://example.com/foo', 'https://example.com/bar');
----
false

# Named group pattern match
query I
SELECT urlpattern_test('https://example.com/users/:id', 'https://example.com/users/123');
----
true

# Named group non-match (wrong path)
query I
SELECT urlpattern_test('https://example.com/users/:id', 'https://example.com/posts/123');
----
false

# Wildcard in pathname
query I
SELECT urlpattern_test('https://example.com/api/*', 'https://example.com/api/v1/users');
----
true

# Multiple path segments with wildcards
query I
SELECT urlpattern_test('https://example.com/api/*/users/*', 'https://example.com/api/v1/users/123');
----
true

# Protocol mismatch
query I
SELECT urlpattern_test('https://example.com/*', 'http://example.com/test');
----
false

# Hostname mismatch
query I
SELECT urlpattern_test('https://example.com/*', 'https://other.com/test');
----
false

# Wildcard hostname
query I
SELECT urlpattern_test('https://*.example.com/*', 'https://api.example.com/test');
----
true

#------------------------------------------------------------------------------
# urlpattern_extract - Named group extraction
#------------------------------------------------------------------------------

# Extract single named group
query I
SELECT urlpattern_extract('https://example.com/users/:id', 'https://example.com/users/123', 'id');
----
123

# Multiple groups - extract version
query I
SELECT urlpattern_extract('https://example.com/api/:version/:resource', 'https://example.com/api/v1/users', 'version');
----
v1

# Multiple groups - extract resource
query I
SELECT urlpattern_extract('https://example.com/api/:version/:resource', 'https://example.com/api/v1/users', 'resource');
----
users

# Extract from hostname pattern
query I
SELECT urlpattern_extract('https://:subdomain.example.com/users/:id', 'https://api.example.com/users/456', 'id');
----
456

query I
SELECT urlpattern_extract('https://:subdomain.example.com/users/:id', 'https://api.example.com/users/456', 'subdomain');
----
api

#------------------------------------------------------------------------------
# urlpattern_pathname - Get pathname component of pattern
#------------------------------------------------------------------------------

query I
SELECT urlpattern_pathname('https://example.com/api/:version/*');
----
/api/:version/*

query I
SELECT urlpattern_pathname('https://example.com/users/:id');
----
/users/:id

query I
SELECT urlpattern_pathname('https://example.com/*');
----
/*

#------------------------------------------------------------------------------
# urlpattern_protocol - Get protocol component of pattern
#------------------------------------------------------------------------------

query I
SELECT urlpattern_protocol('https://example.com/*');
----
https

query I
SELECT urlpattern_protocol('http://example.com/*');
----
http

#------------------------------------------------------------------------------
# urlpattern_hostname - Get hostname component of pattern
#------------------------------------------------------------------------------

query I
SELECT urlpattern_hostname('https://example.com/*');
----
example.com

query I
SELECT urlpattern_hostname('https://*.example.com/*');
----
*.example.com

query I
SELECT urlpattern_hostname('https://:subdomain.example.com/*');
----
:subdomain.example.com

#------------------------------------------------------------------------------
# urlpattern_port - Get port component of pattern
#------------------------------------------------------------------------------

query I
SELECT urlpattern_port('https://example.com:8080/*');
----
8080

query I
SELECT urlpattern_port('https://example.com:3000/api/*');
----
3000

#------------------------------------------------------------------------------
# urlpattern_search - Get search/query component of pattern
#------------------------------------------------------------------------------

query I
SELECT urlpattern_search('https://example.com/*?*');
----
*

#------------------------------------------------------------------------------
# urlpattern_hash - Get hash/fragment component of pattern
#------------------------------------------------------------------------------

query I
SELECT urlpattern_hash('https://example.com/*#*');
----
*

query I
SELECT urlpattern_hash('https://example.com/path#section');
----
section

#------------------------------------------------------------------------------
# urlpattern_exec - Full pattern execution with STRUCT result
#------------------------------------------------------------------------------

# Basic match with single group
query I
SELECT (urlpattern_exec('https://example.com/users/:id', 'https://example.com/users/123')).matched;
----
true

query I
SELECT (urlpattern_exec('https://example.com/users/:id', 'https://example.com/users/123')).pathname;
----
/users/123

query I
SELECT (urlpattern_exec('https://example.com/users/:id', 'https://example.com/users/123')).groups['id'];
----
123

# Multiple groups extraction
query I
SELECT (urlpattern_exec('https://example.com/api/:version/:resource/:id', 'https://example.com/api/v1/users/123')).groups['version'];
----
v1

query I
SELECT (urlpattern_exec('https://example.com/api/:version/:resource/:id', 'https://example.com/api/v1/users/123')).groups['resource'];
----
users

# Non-matching URL returns matched=false
query I
SELECT (urlpattern_exec('https://example.com/users/:id', 'https://example.com/posts/123')).matched;
----
false

# Groups from different URL components (hostname and pathname)
query I
SELECT (urlpattern_exec('https://:tenant.example.com/users/:id', 'https://acme.example.com/users/456')).groups['tenant'];
----
acme

query I
SELECT (urlpattern_exec('https://:tenant.example.com/users/:id', 'https://acme.example.com/users/456')).groups['id'];
----
456

# NULL handling
query I
SELECT urlpattern_exec(NULL, 'https://example.com/users/123') IS NULL;
----
true

query I
SELECT urlpattern_exec('https://example.com/users/:id', NULL) IS NULL;
----
true

#------------------------------------------------------------------------------
# URLPATTERN Type - Custom type functionality
#------------------------------------------------------------------------------

# urlpattern() constructor creates URLPATTERN type
query I
SELECT typeof(urlpattern('https://example.com/*'));
----
URLPATTERN

# Explicit URLPATTERN type works with functions
query I
SELECT urlpattern_test(urlpattern('https://example.com/users/:id'), 'https://example.com/users/123');
----
true

# Implicit cast from VARCHAR to URLPATTERN
query I
SELECT urlpattern_test('https://example.com/users/:id', 'https://example.com/users/456');
----
true

# URLPATTERN can be stored in tables
statement ok
CREATE TABLE test_patterns (name VARCHAR, pattern URLPATTERN);

statement ok
INSERT INTO test_patterns VALUES ('users', 'https://example.com/users/:id');

statement ok
INSERT INTO test_patterns VALUES ('posts', 'https://example.com/posts/:slug');

query II
SELECT name, pattern FROM test_patterns ORDER BY name;
----
posts	https://example.com/posts/:slug
users	https://example.com/users/:id

# Pattern matching using patterns from table
query III
SELECT name, pattern, urlpattern_test(pattern, 'https://example.com/users/123') as matches
FROM test_patterns ORDER BY name;
----
posts	https://example.com/posts/:slug	false
users	https://example.com/users/:id	true

# Extract using pattern from table
query I
SELECT urlpattern_extract(pattern, 'https://example.com/users/789', 'id')
FROM test_patterns WHERE name = 'users';
----
789

# Clean up
statement ok
DROP TABLE test_patterns;

# Invalid pattern in constructor throws error
statement error
SELECT urlpattern('https://[invalid');
----
Invalid URL pattern

# Invalid pattern in implicit cast throws error
statement error
SELECT urlpattern_test('https://[invalid', 'https://example.com');
----
Invalid URL pattern

#------------------------------------------------------------------------------
# urlpattern_init - Component-based patterns (path-only support)
#------------------------------------------------------------------------------

# Path-only pattern matches any protocol/hostname
query I
SELECT urlpattern_test(urlpattern_init(pathname := '/users/:id'), 'https://example.com/users/123');
----
true

# Path-only pattern works with different protocols
query I
SELECT urlpattern_test(urlpattern_init(pathname := '/users/:id'), 'http://other.org/users/456');
----
true

# Path-only pattern extracts groups correctly
query I
SELECT urlpattern_extract(urlpattern_init(pathname := '/users/:id'), 'https://example.com/users/789', 'id');
----
789

# Path-only pattern with multiple segments
query I
SELECT urlpattern_test(urlpattern_init(pathname := '/api/:version/:resource'), 'https://api.example.com/api/v1/users');
----
true

# Path-only pattern with wildcards
query I
SELECT urlpattern_test(urlpattern_init(pathname := '/files/*'), 'https://cdn.example.com/files/docs/readme.txt');
----
true

# Path-only pattern non-match
query I
SELECT urlpattern_test(urlpattern_init(pathname := '/users/:id'), 'https://example.com/posts/123');
----
false

# Hostname-only pattern
query I
SELECT urlpattern_test(urlpattern_init(hostname := '*.example.com'), 'https://api.example.com/anything');
----
true

# Combined hostname and pathname pattern
query I
SELECT urlpattern_test(urlpattern_init(hostname := 'api.example.com', pathname := '/v1/*'), 'https://api.example.com/v1/users');
----
true

# Protocol constraint with path
query I
SELECT urlpattern_test(urlpattern_init(protocol := 'https', pathname := '/secure/*'), 'https://any.host/secure/data');
----
true

# Protocol constraint rejects wrong protocol
query I
SELECT urlpattern_test(urlpattern_init(protocol := 'https', pathname := '/secure/*'), 'http://any.host/secure/data');
----
false

# Extract from hostname group
query I
SELECT urlpattern_extract(urlpattern_init(hostname := ':tenant.example.com', pathname := '/api/*'), 'https://acme.example.com/api/users', 'tenant');
----
acme

# Full exec with path-only pattern
query I
SELECT (urlpattern_exec(urlpattern_init(pathname := '/users/:id'), 'https://example.com/users/42')).matched;
----
true

query I
SELECT (urlpattern_exec(urlpattern_init(pathname := '/users/:id'), 'https://example.com/users/42')).pathname;
----
/users/42

query I
SELECT (urlpattern_exec(urlpattern_init(pathname := '/users/:id'), 'https://example.com/users/42')).groups['id'];
----
42

#------------------------------------------------------------------------------
# Auto-detected path-only patterns (simpler syntax)
#------------------------------------------------------------------------------

# Path pattern auto-detected from string starting with /
query I
SELECT urlpattern_test('/users/:id', 'https://example.com/users/123');
----
true

# Path pattern works with any host
query I
SELECT urlpattern_test('/api/*', 'http://localhost:8080/api/v1/users');
----
true

# Path pattern extraction works
query I
SELECT urlpattern_extract('/users/:id', 'https://example.com/users/456', 'id');
----
456

# Path pattern with multiple segments
query I
SELECT urlpattern_test('/api/:version/:resource/:id', 'https://api.example.com/api/v2/posts/789');
----
true

# Path pattern non-match
query I
SELECT urlpattern_test('/users/:id', 'https://example.com/posts/123');
----
false

# Path pattern in exec
query I
SELECT (urlpattern_exec('/products/:category/:id', 'https://shop.example.com/products/electronics/42')).groups['category'];
----
electronics

# URLPATTERN type accepts path-only patterns
query I
SELECT urlpattern_test(urlpattern('/files/*'), 'https://cdn.example.com/files/image.png');
----
true

# Cast to URLPATTERN works with path patterns
query I
SELECT urlpattern_test('/docs/:page'::URLPATTERN, 'https://docs.example.com/docs/getting-started');
----
true

#------------------------------------------------------------------------------
# URL Parsing Functions
#------------------------------------------------------------------------------

# url_parse returns a struct with all components
query I
SELECT (url_parse('https://user:pass@example.com:8080/path/to/page?foo=bar&baz=qux#section')).protocol;
----
https:

query I
SELECT (url_parse('https://user:pass@example.com:8080/path/to/page?foo=bar#section')).hostname;
----
example.com

query I
SELECT (url_parse('https://example.com:8080/path')).port;
----
8080

query I
SELECT (url_parse('https://example.com/path/to/page')).pathname;
----
/path/to/page

query I
SELECT (url_parse('https://example.com?foo=bar&baz=qux')).search;
----
?foo=bar&baz=qux

query I
SELECT (url_parse('https://example.com/page#section')).hash;
----
#section

query I
SELECT (url_parse('https://user:pass@example.com/')).username;
----
user

query I
SELECT (url_parse('https://user:pass@example.com/')).password;
----
pass

query I
SELECT (url_parse('https://example.com:443/path')).origin;
----
https://example.com

# Individual URL component functions
query I
SELECT url_protocol('https://example.com/path');
----
https:

query I
SELECT url_host('https://example.com:8080/path');
----
example.com:8080

query I
SELECT url_hostname('https://example.com:8080/path');
----
example.com

query I
SELECT url_port('https://example.com:8080/path');
----
8080

query I
SELECT url_pathname('https://example.com/users/123');
----
/users/123

query I
SELECT url_search('https://example.com?q=test&page=1');
----
?q=test&page=1

query I
SELECT url_hash('https://example.com/page#top');
----
#top

query I
SELECT url_origin('https://api.example.com:8443/endpoint');
----
https://api.example.com:8443

query I
SELECT url_href('HTTPS://EXAMPLE.COM/Path');
----
https://example.com/Path

query I
SELECT url_valid('https://example.com');
----
true

query I
SELECT url_valid('not a url');
----
false

# Empty components return empty strings
query I
SELECT length(url_port('https://example.com/path'));
----
0

query I
SELECT length(url_search('https://example.com/path'));
----
0

query I
SELECT length(url_hash('https://example.com/path'));
----
0

#------------------------------------------------------------------------------
# Query Parameter Functions
#------------------------------------------------------------------------------

# url_search_param extracts single parameter
query I
SELECT url_search_param('https://example.com?page=5&sort=asc', 'page');
----
5

query I
SELECT url_search_param('https://example.com?page=5&sort=asc', 'sort');
----
asc

# Missing parameter returns NULL
query I
SELECT url_search_param('https://example.com?page=5', 'missing') IS NULL;
----
true

# url_search_params returns MAP of all parameters
query I
SELECT url_search_params('https://example.com?a=1&b=2')['a'];
----
1

query I
SELECT url_search_params('https://example.com?a=1&b=2')['b'];
----
2

# Empty search returns empty map
query I
SELECT map_keys(url_search_params('https://example.com/path'));
----
[]

#------------------------------------------------------------------------------
# URL Resolution
#------------------------------------------------------------------------------

# Resolve relative paths
query I
SELECT url_resolve('https://example.com/docs/guide/', '../api/users');
----
https://example.com/docs/api/users

query I
SELECT url_resolve('https://example.com/docs/', 'getting-started');
----
https://example.com/docs/getting-started

# Absolute URL overrides base
query I
SELECT url_resolve('https://example.com/', 'https://other.com/path');
----
https://other.com/path

# Protocol-relative URL
query I
SELECT url_resolve('https://example.com/', '//cdn.example.com/asset.js');
----
https://cdn.example.com/asset.js

# Root-relative path
query I
SELECT url_resolve('https://example.com/docs/guide/', '/api/v1');
----
https://example.com/api/v1
